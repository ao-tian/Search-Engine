{% extends "base.html" %}

{% block title %}Metrics Dashboard - Search Engine{% endblock %}

{% block extra_styles %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .metric-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-value {
        font-size: 2.5em;
        font-weight: 600;
        color: #667eea;
    }
    
    .metric-unit {
        font-size: 0.6em;
        color: #999;
        margin-left: 5px;
    }
    
    .section-title {
        font-size: 1.5em;
        color: #667eea;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
    }
    
    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .stats-table th,
    .stats-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .stats-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }
    
    .stats-table tr:hover {
        background: #f8f9fa;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Metrics Dashboard</h1>
    <div class="page-subtitle">Pipeline health, query performance, and data quality metrics</div>
    <div style="margin-top: 15px;">
        <a href="/api/export-metrics?format=json" class="btn btn-primary" style="margin-right: 10px;" download>Export JSON</a>
        <a href="/api/export-metrics?format=csv" class="btn btn-primary" download>Export CSV</a>
    </div>
</div>

<!-- System Metrics -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total Documents</div>
        <div class="metric-value">{{ system_metrics.total_documents }}</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Total Queries</div>
        <div class="metric-value">{{ system_metrics.total_queries }}</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Cache Hit Rate</div>
        <div class="metric-value">{{ "%.1f"|format(system_metrics.cache_hit_rate * 100) }}<span class="metric-unit">%</span></div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Avg Query Latency</div>
        <div class="metric-value">{{ "%.2f"|format(system_metrics.avg_query_latency_ms) }}<span class="metric-unit">ms</span></div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">P95 Latency</div>
        <div class="metric-value">{{ "%.2f"|format(system_metrics.p95_latency_ms) }}<span class="metric-unit">ms</span></div>
    </div>
    
    <div class="metric-card">
        <div class="metric-label">Vocabulary Size</div>
        <div class="metric-value">{{ system_metrics.vocabulary_size }}</div>
    </div>
</div>

<!-- Query Statistics -->
<div class="card">
    <h2 class="section-title">Query Performance</h2>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Total Queries</td>
                <td>{{ query_stats.get('total', 0) }}</td>
            </tr>
            <tr>
                <td>Average Latency</td>
                <td>{{ "%.2f"|format(query_stats.get('avg_latency_ms', 0)) }} ms</td>
            </tr>
            <tr>
                <td>Cache Hits</td>
                <td>{{ query_stats.get('cache_hits', 0) }}</td>
            </tr>
            <tr>
                <td>Cache Misses</td>
                <td>{{ query_stats.get('cache_misses', 0) }}</td>
            </tr>
            <tr>
                <td>Cache Hit Rate</td>
                <td>{{ "%.1f"|format(query_stats.get('cache_hit_rate', 0) * 100) }}%</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Pipeline Metrics -->
{% if pipeline_metrics %}
<div class="card">
    <h2 class="section-title">Latest Pipeline Run</h2>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Run ID</td>
                <td>{{ pipeline_metrics.run_id }}</td>
            </tr>
            <tr>
                <td>Timestamp</td>
                <td>{{ pipeline_metrics.timestamp }}</td>
            </tr>
            <tr>
                <td>Documents Ingested</td>
                <td><span class="badge badge-success">{{ pipeline_metrics.docs_ingested }}</span></td>
            </tr>
            <tr>
                <td>Documents Skipped</td>
                <td>{{ pipeline_metrics.docs_skipped }}</td>
            </tr>
            <tr>
                <td>Duplicates Detected</td>
                <td>{{ pipeline_metrics.docs_duplicate }}</td>
            </tr>
            <tr>
                <td>Tokens Processed</td>
                <td>{{ pipeline_metrics.tokens_processed }}</td>
            </tr>
            <tr>
                <td>Unique Terms</td>
                <td>{{ pipeline_metrics.unique_terms }}</td>
            </tr>
            <tr>
                <td>Total Processing Time</td>
                <td>{{ "%.3f"|format(pipeline_metrics.total_time) }}s</td>
            </tr>
            <tr>
                <td>Extraction Time</td>
                <td>{{ "%.3f"|format(pipeline_metrics.extraction_time) }}s</td>
            </tr>
            <tr>
                <td>Transformation Time</td>
                <td>{{ "%.3f"|format(pipeline_metrics.transformation_time) }}s</td>
            </tr>
            <tr>
                <td>Indexing Time</td>
                <td>{{ "%.3f"|format(pipeline_metrics.indexing_time) }}s</td>
            </tr>
        </tbody>
    </table>
    
    {% if pipeline_metrics.errors %}
    <div style="margin-top: 20px;">
        <h3 style="color: #dc3545; margin-bottom: 10px;">Errors</h3>
        <ul>
            {% for error in pipeline_metrics.errors %}
            <li style="color: #721c24;">{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Recent Queries -->
{% if recent_queries %}
<div class="card">
    <h2 class="section-title">Recent Queries</h2>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Query</th>
                <th>Results</th>
                <th>Latency</th>
                <th>Cache</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for query in recent_queries|reverse %}
            <tr>
                <td>{{ query.query }}</td>
                <td>{{ query.result_count }}</td>
                <td>{{ "%.2f"|format(query.latency_ms) }} ms</td>
                <td>
                    {% if query.cache_hit %}
                    <span class="badge badge-success">Hit</span>
                    {% else %}
                    <span class="badge badge-info">Miss</span>
                    {% endif %}
                </td>
                <td>{{ query.timestamp[:19] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Index Versions -->
<div class="card">
    <h2 class="section-title">Index Versions</h2>
    <div id="versions-container">
        <p style="color: #999;">Loading versions...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load index versions
    fetch('/api/index-versions')
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            const container = document.getElementById('versions-container');
            if (data.versions && data.versions.length > 0) {
                let html = '<table class="stats-table"><thead><tr><th>Version</th><th>Timestamp</th><th>Documents</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                data.versions.forEach(v => {
                    const isCurrent = v.version_id === data.current_version;
                    html += `<tr ${isCurrent ? 'style="background: #e8f5e9;"' : ''}>`;
                    html += `<td>${v.version_id} ${isCurrent ? '<span class="badge badge-success">Current</span>' : ''}</td>`;
                    html += `<td>${v.timestamp}</td>`;
                    html += `<td>${v.document_count}</td>`;
                    html += `<td>${v.description || ''}</td>`;
                    html += `<td>`;
                    if (!isCurrent) {
                        html += `<button onclick="loadVersion('${v.version_id}')" class="btn btn-primary btn-small" style="margin-right: 5px;">Load</button>`;
                        html += `<button onclick="deleteVersion('${v.version_id}')" class="btn btn-danger btn-small">Delete</button>`;
                    }
                    html += `</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p style="color: #999;">No versions available</p>';
            }
        })
        .catch(error => {
            const container = document.getElementById('versions-container');
            container.innerHTML = `<p style="color: #dc3545;">Error loading versions: ${error.message}</p>`;
            console.error('Error loading versions:', error);
        });
    
    function loadVersion(versionId) {
        if (!confirm(`Load version ${versionId}? This will replace the current index.`)) {
            return;
        }
        
        fetch(`/api/index-versions/${versionId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Version loaded successfully. Reloading page...');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to load version'));
                }
            });
    }
    
    function deleteVersion(versionId) {
        if (!confirm(`Delete version ${versionId}? This cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/index-versions/${versionId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Version deleted. Reloading page...');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete version'));
                }
            });
    }
</script>
{% endblock %}
